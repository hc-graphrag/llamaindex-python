# 要件定義書

## はじめに

ローカル検索は、GraphRAGシステムにおいて、特定のエンティティとその関係性に焦点を当てた検索機能を提供します。現在未実装のこの機能を、必要最小限の要素から段階的に構築します。

## 実装方針

- **段階的実装**: 動作する最小限の機能から開始
- **シンプルな設計**: 複雑な機能は後回し
- **実用性重視**: まず動くものを作る

## 要件

### 要件1: エンティティと関係性のデータモデル

**ユーザーストーリー:** 開発者として、エンティティ、関係性、テキストユニットの構造化されたデータモデルが欲しい。それにより、ナレッジグラフを効率的に管理・クエリできるようになる。

#### 受け入れ基準

1. エンティティオブジェクトを作成する際、システムはid、title、description、rank、community_ids、text_unit_ids、attributesのフィールドを含むものとする
2. 関係性が定義される場合、システムはsource、target、description、weight、rank、text_unit_ids、attributesを含むものとする
3. TextUnitsを扱う際、システムはid、text、short_id、relationship_ids、attributesを維持するものとする
4. 共変量が使用される場合、システムはsubject_idと柔軟な属性フィールドをサポートするものとする

### 要件2: クエリからエンティティへのマッピング

**ユーザーストーリー:** ユーザーとして、クエリが関連するエンティティにインテリジェントにマッピングされることを望む。それにより、正確でコンテキストに沿った結果を得られる。

#### 受け入れ基準

1. クエリが送信された場合、システムはベクトル埋め込みを使用して意味的に類似したエンティティを見つけるものとする
2. 包含/除外エンティティリストが提供された場合、システムはこれらの制約を尊重するものとする
3. クエリが提供されない場合、システムはrank属性によって上位ランクのエンティティを返すものとする
4. oversample_scalerが設定されている場合、システムはフィルタリング用にk * oversample_scaler個の候補を取得するものとする

### 要件3: 基本的なコンテキスト構築

**ユーザーストーリー:** 開発者として、シンプルなコンテキスト構築機能が欲しい。それにより、ローカル検索が動作する。

#### 受け入れ基準

1. コンテキストを構築する際、システムはmax_context_tokens制限（デフォルト8000）を考慮する
2. エンティティ、関係性、テキストユニットの基本的な組み合わせができる
3. トークン制限を超える場合は、単純に切り捨てる

### 要件4: 基本的な関係性の取得

**ユーザーストーリー:** ユーザーとして、選択されたエンティティの関係性を取得して欲しい。

#### 受け入れ基準

1. システムは選択されたエンティティに関連する関係性を取得する
2. 基本的なフィルタリング（上限数の設定など）ができる

### 要件5: 基本的なコンテキスト統合

**ユーザーストーリー:** ユーザーとして、エンティティと関係性からの基本的なコンテキストが欲しい。

#### 受け入れ基準

1. システムはエンティティと関係性データを組み合わせる
2. テキストユニットが存在する場合は含める（共変量とコミュニティは後回し）

### 要件6: 検索インターフェースと応答生成

**ユーザーストーリー:** ユーザーとして、統一された検索インターフェースが欲しい。それにより、フォーマットされた結果を得られる。

#### 受け入れ基準

1. ローカル検索を実行する際、システムは同期モードをサポートするものとする
2. response_typeが指定されている場合、システムはそれに応じて出力をフォーマットするものとする（複数段落、単一段落、リストなど）
3. 応答を生成する際、システムは[Data: <source> (ids)]形式でデータ引用を含めるものとする

### 要件7: 既存インフラとの統合

**ユーザーストーリー:** 開発者として、ローカル検索が既存コンポーネントとシームレスに統合されることを望む。それにより、システムの一貫性が保たれる。

#### 受け入れ基準

1. ローカル検索が有効な場合、SearchModeRouterは適切にクエリをルーティングするものとする
2. ベクトルストアが設定されている場合、システムはエンティティとテキスト埋め込みにそれらを使用するものとする
3. LOCALモードが選択された場合、システムはLocalSearchRetrieverを実行するものとする
4. 自動モードがアクティブな場合、システムはローカル検索とグローバル検索を知的に選択するものとする

## 非機能要件

### コードアーキテクチャとモジュール性
- **単一責任の原則**: エンティティ抽出、コンテキスト構築、検索オーケストレーションの関心事を分離
- **モジュラー設計**: データモデル、コンテキストビルダー、検索プロセッサーの独立したモジュール
- **依存関係管理**: LocalSearch、コンテキストビルダー、ベクトルストア間の明確なインターフェース
- **明確なインターフェース**: LocalContextBuilder抽象基底クラスのための明確に定義された契約

### パフォーマンス
- 初期実装では特定のパフォーマンス目標は設定しない
- 動作することを最優先とする

### セキュリティ
- **入力検証**: すべてのユーザークエリと設定パラメータをサニタイズ
- **アクセス制御**: 設定されたエンティティ包含/除外リストを尊重
- **データプライバシー**: 機密性の高いエンティティや関係性データのログを記録しない
- **APIセキュリティ**: LLM APIキーと認証情報の安全な処理

### 信頼性
- **基本的なエラー処理**: エラー時は適切なエラーメッセージを返す
- **データ検証**: 基本的なデータ構造の検証のみ実装

### 使いやすさ
- **基本的なエラーメッセージ**: エラー時の簡潔なメッセージ
- **必要最小限の設定**: 動作に必要な最小限のパラメータのみ
- **基本的なドキュメント**: 主要な関数のdocstring